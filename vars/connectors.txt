@Library('library')_
pipeline{
agent any
stages{
	stage('git clone'){
		steps{
			
			sh "sudo rm -rf Game"
			sh "git clone https://github.com/maheedhar132/Game.git"
			}
	}
	stage('Fetch token'){
	steps{
	sh "rm -rf /var/lib/jenkins/workspace/${JOB_NAME}/node_sltoken.txt"
	sealights_token(jsondata)
	}
	}
	stage('Set Quality Gate')
	{
	steps{
	setQualityGate(jsondata)
	}
	}
	stage('Get Current Build Metrics'){
	steps{
	getCurrentBuildMetrics()
	}
	}
	stage('Build agent'){
		steps{
		sh "cd Game && sudo npm i slnodejs"
		sh "cd Game/client && sudo npm i slnodejs"
		sh "./Game/node_modules/.bin/slnodejs config --tokenfile /var/lib/jenkins/workspace/${JOB_NAME}/node_sltoken.txt --appname '${JOB_NAME}' --branch 'poc' --build '${BUILD_NUMBER}'"
		sh "export SL_BUILD_SESSION_ID=`cat buildSessionId`"
		}
	}
	
	
	stage('Build'){
		steps{
			//sh "rm -rf Game/package-lock.json"
			//sh "sudo rm -rf Game/node_modules"
			//sh "sudo rm -rf Game/client/node_modules"
			//sh "cd Game && sudo npm run build"
			sh "cd Game/client && sudo npm install"
			sh "cd Game && sudo npm install"
			sh "cd Game/client && sudo npm run build"
			sh 'cd Game/client && ./node_modules/.bin/slnodejs build --tokenfile /var/lib/jenkins/workspace/${JOB_NAME}/node_sltoken.txt --buildsessionidfile /var/lib/jenkins/workspace/${JOB_NAME}/buildSessionId --instrumentForBrowsers  --workspacepath build --outputpath sl_build --scm none'

			//sh "pwd"
			//sh "cd Game/client && pwd &&  npm install"
			//sh "cd Game && pwd &&  npm install"
			sh "mv Game/client/build Game/client/old_build"
			sh "mv Game/client/sl_build Game/client/build"
		}
	}
	
	/*stage('Build Session ID'){
		steps{
		
		sh "cd Game ./node_modules/.bin/slnodejs start --tokenfile /var/lib/jenkins/workspace/${JOB_NAME}/node_sltoken.txt --buildsessionidfile /var/lib/jenkins/workspace/${JOB_NAME}/buildSessionId --teststage 'Unit Tests'"
		}
	}*/
	stage('Run'){
		steps{
			sh "pwd"
			//sh 'cd Game && sudo forever start -c "npm start" .'
			//sh 'cd Game && npm start'
			sh 'cd Game && npm start'
			//sh 'cd Game/client && npm start'
			
		}
	}
}
}
